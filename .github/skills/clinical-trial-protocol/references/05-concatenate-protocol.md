# Step 5: Concatenate Final Protocol

## Purpose

Concatenate all protocol section files into a single, complete clinical trial protocol document.

## Prerequisites

**Required Files:**
- `waypoints/intervention_metadata.json`
- `waypoints/02_protocol_metadata.json` (must show step_4_status: "completed")
- `waypoints/02_protocol_foundation.md` (Sections 1-6)
- `waypoints/03_protocol_intervention.md` (Sections 7-8)
- `waypoints/04_protocol_operations.md` (Sections 9-12)

---

## What This Subskill Does

1. Verifies Step 4 completion
2. Reads all protocol section files
3. Concatenates sections in order with proper formatting
4. Adds table of contents
5. Creates final protocol document
6. Updates all metadata files
7. Displays completion summary

---

## Execution Flow

### Step 1: Verify Prerequisites

Read `waypoints/02_protocol_metadata.json` and verify:
- `step_4_status` is "completed"
- All section files exist:
  - `waypoints/02_protocol_foundation.md`
  - `waypoints/03_protocol_intervention.md`
  - `waypoints/04_protocol_operations.md`

**If Step 4 not completed:**
```
Error: Step 4 must be completed before concatenation.
Step 4 status: [current status]

Please complete Step 4 to generate final protocol sections (9-12).
```
Exit.

**If any section files missing:**
```
Error: Required protocol section files not found.
Expected:
  - waypoints/02_protocol_foundation.md (Step 2 output)
  - waypoints/03_protocol_intervention.md (Step 3 output)
  - waypoints/04_protocol_operations.md (Step 4 output)

Please ensure Steps 2, 3, and 4 are completed.
```
Exit.

---

### Step 2: Read All Section Files

Read the content of each protocol section file:
1. `02_protocol_foundation.md` - Sections 1-6
2. `03_protocol_intervention.md` - Sections 7-8
3. `04_protocol_operations.md` - Sections 9-12

---

### Step 3: Generate Final Protocol

Create `waypoints/protocol_complete.md` with:

1. **Header Block:**
```markdown
# [Protocol Title]

**Protocol Version:** 1.0 Draft  
**Protocol Date:** [Date]  
**Intervention:** [Intervention Name]  
**Intervention Type:** [Device/Drug]  
**Regulatory Pathway:** [IDE/IND]

---

‚ö†Ô∏è **DRAFT DOCUMENT**
This protocol is for planning and discussion purposes only.
Requires review and approval before implementation.

---
```

2. **Table of Contents:**
Generate linked table of contents for all 12 sections.

3. **Protocol Content:**
Concatenate all section files in order:
- Sections 1-6 (from foundation)
- Sections 7-8 (from intervention)
- Sections 9-12 (from operations)

4. **Footer:**
```markdown
---

## Document History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 Draft | [Date] | AI-Assisted | Initial draft |

---

*Generated by Clinical Trial Protocol Skill*
*Requires review by: Regulatory Affairs, Biostatistics, Clinical Operations, Medical Monitor*
```

---

### Step 4: Update Metadata

**Update `waypoints/02_protocol_metadata.json`:**
```json
{
  ...existing fields...,
  "step_5_status": "completed",
  "sections_completed": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
  "sections_pending": [],
  "concatenation_date": "[current date]",
  "notes": [
    "DRAFT for planning purposes",
    "Complete protocol (Sections 1-12) concatenated",
    "Requires biostatistician review",
    "Requires clinical expert review",
    "Requires IRB approval",
    "Requires FDA feedback"
  ]
}
```

**Update `waypoints/intervention_metadata.json`:**
```json
{
  ...existing fields...,
  "completed_steps": [
    "00-initialize-intervention",
    "01-research-protocols",
    "02-protocol-foundation",
    "03-protocol-intervention",
    "04-protocol-operations",
    "05-concatenate-protocol"
  ],
  "protocol_status": "complete",
  "final_protocol_file": "waypoints/protocol_complete.md"
}
```

---

### Step 5: Display Completion Summary

```
‚úÖ CLINICAL TRIAL PROTOCOL GENERATION COMPLETE

Intervention: [Name]
Type: [Device/Drug]
Indication: [Indication]

Protocol Details:
  ‚Ä¢ Version: 1.0 Draft
  ‚Ä¢ Date: [Current date]
  ‚Ä¢ Study Design: [Design]
  ‚Ä¢ Sample Size: [N subjects]
  ‚Ä¢ Primary Endpoint: [Endpoint]
  ‚Ä¢ Study Duration: [Duration]

üìÑ FINAL PROTOCOL DOCUMENT

File: waypoints/protocol_complete.md
Size: [Size in KB]
Lines: [Line count]
Sections: All 12 sections (1-12)

‚úì Section 1: Statement of Compliance
‚úì Section 2: Protocol Summary
‚úì Section 3: Introduction
‚úì Section 4: Objectives and Endpoints
‚úì Section 5: Study Design
‚úì Section 6: Study Population
‚úì Section 7: Study Intervention
‚úì Section 8: Discontinuation
‚úì Section 9: Study Assessments
‚úì Section 10: Statistical Considerations
‚úì Section 11: Supporting Documentation
‚úì Section 12: References

Supporting Files:
  ‚Ä¢ waypoints/02_protocol_foundation.md (Sections 1-6)
  ‚Ä¢ waypoints/03_protocol_intervention.md (Sections 7-8)
  ‚Ä¢ waypoints/04_protocol_operations.md (Sections 9-12)
  ‚Ä¢ waypoints/02_sample_size_calculation.json
  ‚Ä¢ waypoints/01_clinical_research_summary.json

Similar Trials Referenced: [N trials]
FDA Guidance Documents: [N documents]

‚ö†Ô∏è IMPORTANT DISCLAIMERS

This is a DRAFT protocol for planning and discussion purposes ONLY.

REQUIRED BEFORE STUDY INITIATION:
  ‚ñ° Biostatistician review of statistical sections
  ‚ñ° Clinical expert review of medical content
  ‚ñ° Regulatory affairs review for compliance
  ‚ñ° Legal review for liability considerations
  ‚ñ° IRB/Ethics Committee approval
  ‚ñ° FDA/regulatory agency feedback (if required)
  ‚ñ° Sponsor approval

The AI-generated protocol provides a starting framework. All content
must be validated by qualified professionals before implementation.
```

---

## Output Files

**Created:**
- `waypoints/protocol_complete.md` (Complete protocol with all 12 sections)

**Updated:**
- `waypoints/02_protocol_metadata.json` (step 5 marked complete, final file path added)
- `waypoints/intervention_metadata.json` (step 5 marked complete)

**Preserved:**
- `waypoints/02_protocol_foundation.md` (Sections 1-6 from Step 2)
- `waypoints/03_protocol_intervention.md` (Sections 7-8 from Step 3)
- `waypoints/04_protocol_operations.md` (Sections 9-12 from Step 4)

---

## Error Handling

**If concatenation fails:**
```
Error: Failed to concatenate protocol sections.
[Error details]

Individual section files are preserved:
  ‚Ä¢ waypoints/02_protocol_foundation.md
  ‚Ä¢ waypoints/03_protocol_intervention.md
  ‚Ä¢ waypoints/04_protocol_operations.md

You can manually combine these files or retry concatenation.
```

---

## Quality Checks

Before marking complete:
- [ ] All 12 sections present in final document
- [ ] Table of contents generated
- [ ] Section numbering consistent
- [ ] No duplicate content
- [ ] Header and footer added
- [ ] Metadata files updated
- [ ] File size reasonable (typically 100-500KB)

---

## Notes for Claude/Copilot

1. **Preserve formatting:** Maintain markdown structure from source files
2. **Check consistency:** Ensure section numbering flows correctly
3. **Add navigation:** Table of contents should link to sections
4. **Include disclaimers:** Clearly mark as DRAFT throughout
5. **Calculate metrics:** Report actual file size and line counts
