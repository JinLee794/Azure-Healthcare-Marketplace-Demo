name: Healthcare MCP Platform - Deploy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

permissions:
  id-token: write
  contents: read

env:
  AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
  AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
  AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
  AZURE_ENV_NAME: ${{ vars.AZURE_ENV_NAME || 'healthcare-mcp' }}
  AZURE_LOCATION: ${{ vars.AZURE_LOCATION || 'eastus2' }}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies and validate
        run: |
          for server in src/mcp-servers/*/; do
            echo "Validating $server..."
            cd "$server"
            pip install -r requirements.txt
            python -m py_compile function_app.py
            cd - > /dev/null
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mcp-servers
          path: src/mcp-servers/

  deploy-infra:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    outputs:
      apim_gateway_url: ${{ steps.deploy.outputs.apimGatewayUrl }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install azd
        uses: Azure/setup-azd@v1.0.0

      - name: Log in with Azure (Federated Credentials)
        if: ${{ env.AZURE_CLIENT_ID != '' }}
        run: |
          azd auth login `
            --client-id "$Env:AZURE_CLIENT_ID" `
            --federated-credential-provider "github" `
            --tenant-id "$Env:AZURE_TENANT_ID"
        shell: pwsh

      - name: Provision Infrastructure
        id: deploy
        run: |
          azd provision --no-prompt
        env:
          AZURE_ENV_NAME: ${{ env.AZURE_ENV_NAME }}
          AZURE_LOCATION: ${{ env.AZURE_LOCATION }}
          AZURE_SUBSCRIPTION_ID: ${{ env.AZURE_SUBSCRIPTION_ID }}

  deploy-services:
    runs-on: ubuntu-latest
    needs: deploy-infra
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        service:
          - npi-lookup
          - icd10-validation
          - cms-coverage
          - fhir-operations
          - pubmed
          - clinical-trials
      max-parallel: 3
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: mcp-servers
          path: src/mcp-servers/

      - name: Install azd
        uses: Azure/setup-azd@v1.0.0

      - name: Log in with Azure (Federated Credentials)
        if: ${{ env.AZURE_CLIENT_ID != '' }}
        run: |
          azd auth login `
            --client-id "$Env:AZURE_CLIENT_ID" `
            --federated-credential-provider "github" `
            --tenant-id "$Env:AZURE_TENANT_ID"
        shell: pwsh

      - name: Deploy ${{ matrix.service }}
        run: |
          azd deploy ${{ matrix.service }} --no-prompt
        env:
          AZURE_ENV_NAME: ${{ env.AZURE_ENV_NAME }}
          AZURE_LOCATION: ${{ env.AZURE_LOCATION }}
          AZURE_SUBSCRIPTION_ID: ${{ env.AZURE_SUBSCRIPTION_ID }}

  verify:
    runs-on: ubuntu-latest
    needs: deploy-services
    steps:
      - name: Verify MCP Endpoints
        run: |
          echo "Deployment complete!"
          echo "Run 'azd show' to see deployed resources"
          # Add health check calls here if APIM gateway is publicly accessible
