<!--
    Azure API Management Policy for MCP API with Azure AD Token Validation

    This policy validates Azure Active Directory (AAD) access tokens from incoming requests.
    If validation fails, it returns HTTP 401 with proper WWW-Authenticate header that includes
    the resource_metadata URL for OAuth discovery (PRM pattern).
-->
<policies>
    <inbound>
        <base />
        <!-- Validate Azure AD JWT Token -->
        <validate-azure-ad-token
            tenant-id="{{McpTenantId}}"
            failed-validation-httpcode="401"
            failed-validation-error-message="Unauthorized">
            <audiences>
                <audience>{{McpClientId}}</audience>
            </audiences>
        </validate-azure-ad-token>
    </inbound>
    <backend>
        <base />
    </backend>
    <outbound>
        <base />
        <!-- Add MCP protocol version header -->
        <set-header name="X-MCP-Protocol-Version" exists-action="override">
            <value>{{mcp-protocol-version}}</value>
        </set-header>
        <!-- Security headers -->
        <set-header name="X-Content-Type-Options" exists-action="override">
            <value>nosniff</value>
        </set-header>
        <set-header name="X-Frame-Options" exists-action="override">
            <value>DENY</value>
        </set-header>
    </outbound>
    <on-error>
        <base />
        <choose>
            <!-- Handle authentication/authorization errors with PRM discovery -->
            <when condition="@(context.Response.StatusCode == 401)">
                <return-response>
                    <set-status code="401" reason="Unauthorized" />
                    <set-header name="WWW-Authenticate" exists-action="override">
                        <value>Bearer error="invalid_token", resource_metadata="{{APIMGatewayURL}}/.well-known/oauth-protected-resource"</value>
                    </set-header>
                    <set-header name="Content-Type" exists-action="override">
                        <value>application/json</value>
                    </set-header>
                    <set-body>@{
                        return new JObject(
                            new JProperty("jsonrpc", "2.0"),
                            new JProperty("error", new JObject(
                                new JProperty("code", -32001),
                                new JProperty("message", "Authentication required. Please authenticate using OAuth 2.0.")
                            )),
                            new JProperty("id", null)
                        ).ToString();
                    }</set-body>
                </return-response>
            </when>
            <!-- Handle other errors -->
            <otherwise>
                <return-response>
                    <set-status code="500" reason="Internal Server Error" />
                    <set-header name="Content-Type" exists-action="override">
                        <value>application/json</value>
                    </set-header>
                    <set-body>@{
                        return new JObject(
                            new JProperty("jsonrpc", "2.0"),
                            new JProperty("error", new JObject(
                                new JProperty("code", -32603),
                                new JProperty("message", "Internal error processing MCP request")
                            )),
                            new JProperty("id", null)
                        ).ToString();
                    }</set-body>
                </return-response>
            </otherwise>
        </choose>
    </on-error>
</policies>
