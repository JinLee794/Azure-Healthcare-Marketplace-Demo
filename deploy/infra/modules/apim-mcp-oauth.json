{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "4006677331238219208"
    }
  },
  "parameters": {
    "apimServiceName": {
      "type": "string",
      "metadata": {
        "description": "Name of the API Management service"
      }
    },
    "mcpAppId": {
      "type": "string",
      "metadata": {
        "description": "Client ID of the MCP Entra application"
      }
    },
    "mcpAppTenantId": {
      "type": "string",
      "metadata": {
        "description": "Tenant ID of the MCP Entra application"
      }
    },
    "functionAppBaseName": {
      "type": "string",
      "metadata": {
        "description": "Base name for function apps"
      }
    }
  },
  "variables": {
    "$fxv#0": "<!--\n    Azure API Management Policy for Protected Resource Metadata (RFC 9728)\n    \n    This policy returns Protected Resource Metadata information for OAuth 2.0\n    protected resources. It dynamically constructs the resource URL based on\n    the request context to comply with RFC 9728 requirements.\n    \n    The 'resource' property MUST match the protected resource URL per RFC 9728.\n    When accessed via /.well-known/oauth-protected-resource, returns base URL.\n    When accessed via /mcp/{api}/.well-known/oauth-protected-resource, returns\n    the full MCP endpoint URL.\n    \n    Note: Authentication is disabled for this endpoint to allow anonymous access\n    as per RFC 9728 requirements - clients need to discover auth info before authenticating.\n-->\n<policies>\n    <inbound>\n        <!-- Return Protected Resource Metadata according to RFC 9728 -->\n        <return-response>\n            <set-status code=\"200\" reason=\"OK\" />\n            <set-header name=\"Content-Type\" exists-action=\"override\">\n                <value>application/json</value>\n            </set-header>\n            <set-header name=\"Cache-Control\" exists-action=\"override\">\n                <value>public, max-age=3600</value>\n            </set-header>\n            <set-body>@{\n                // Get the API path context to construct the correct resource URL\n                var apiPath = context.Api.Path;\n                var gatewayUrl = \"{{APIMGatewayURL}}\".TrimEnd('/');\n                \n                // Construct resource URL: base URL for root PRM, or full MCP endpoint URL for per-API PRM\n                string resourceUrl;\n                if (string.IsNullOrEmpty(apiPath) || apiPath == \"/\") {\n                    // Root PRM endpoint - return base gateway URL\n                    resourceUrl = gatewayUrl;\n                } else {\n                    // Per-API PRM endpoint - return the full MCP endpoint URL\n                    resourceUrl = $\"{gatewayUrl}/{apiPath.TrimStart('/')}/mcp\";\n                }\n                \n                return JsonConvert.SerializeObject(new {\n                    // The resource identifier - MUST match the protected resource URL per RFC 9728\n                    resource = resourceUrl,\n                    \n                    // OAuth 2.0 authorization server endpoints\n                    authorization_servers = new[] {\n                        $\"https://login.microsoftonline.com/{{McpTenantId}}/v2.0\"\n                    },\n                    \n                    // How the bearer token should be presented\n                    bearer_methods_supported = new[] {\n                        \"header\"\n                    },\n                    \n                    // Scopes required to access this resource\n                    scopes_supported = new[] {\n                        \"{{McpClientId}}/user_impersonate\"\n                    }\n                });\n            }</set-body>\n        </return-response>\n    </inbound>\n    <backend>\n        <base />\n    </backend>\n    <outbound>\n        <base />\n    </outbound>\n    <on-error>\n        <base />\n    </on-error>\n</policies>\n",
    "$fxv#1": "<!--\n    Azure API Management Policy for Protected Resource Metadata (RFC 9728)\n    \n    This policy returns Protected Resource Metadata information for OAuth 2.0\n    protected resources. It dynamically constructs the resource URL based on\n    the request context to comply with RFC 9728 requirements.\n    \n    The 'resource' property MUST match the protected resource URL per RFC 9728.\n    When accessed via /.well-known/oauth-protected-resource, returns base URL.\n    When accessed via /mcp/{api}/.well-known/oauth-protected-resource, returns\n    the full MCP endpoint URL.\n    \n    Note: Authentication is disabled for this endpoint to allow anonymous access\n    as per RFC 9728 requirements - clients need to discover auth info before authenticating.\n-->\n<policies>\n    <inbound>\n        <!-- Return Protected Resource Metadata according to RFC 9728 -->\n        <return-response>\n            <set-status code=\"200\" reason=\"OK\" />\n            <set-header name=\"Content-Type\" exists-action=\"override\">\n                <value>application/json</value>\n            </set-header>\n            <set-header name=\"Cache-Control\" exists-action=\"override\">\n                <value>public, max-age=3600</value>\n            </set-header>\n            <set-body>@{\n                // Get the API path context to construct the correct resource URL\n                var apiPath = context.Api.Path;\n                var gatewayUrl = \"{{APIMGatewayURL}}\".TrimEnd('/');\n                \n                // Construct resource URL: base URL for root PRM, or full MCP endpoint URL for per-API PRM\n                string resourceUrl;\n                if (string.IsNullOrEmpty(apiPath) || apiPath == \"/\") {\n                    // Root PRM endpoint - return base gateway URL\n                    resourceUrl = gatewayUrl;\n                } else {\n                    // Per-API PRM endpoint - return the full MCP endpoint URL\n                    resourceUrl = $\"{gatewayUrl}/{apiPath.TrimStart('/')}/mcp\";\n                }\n                \n                return JsonConvert.SerializeObject(new {\n                    // The resource identifier - MUST match the protected resource URL per RFC 9728\n                    resource = resourceUrl,\n                    \n                    // OAuth 2.0 authorization server endpoints\n                    authorization_servers = new[] {\n                        $\"https://login.microsoftonline.com/{{McpTenantId}}/v2.0\"\n                    },\n                    \n                    // How the bearer token should be presented\n                    bearer_methods_supported = new[] {\n                        \"header\"\n                    },\n                    \n                    // Scopes required to access this resource\n                    scopes_supported = new[] {\n                        \"{{McpClientId}}/user_impersonate\"\n                    }\n                });\n            }</set-body>\n        </return-response>\n    </inbound>\n    <backend>\n        <base />\n    </backend>\n    <outbound>\n        <base />\n    </outbound>\n    <on-error>\n        <base />\n    </on-error>\n</policies>\n"
  },
  "resources": [
    {
      "type": "Microsoft.ApiManagement/service/namedValues",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}', parameters('apimServiceName'), 'McpTenantId')]",
      "properties": {
        "displayName": "McpTenantId",
        "value": "[parameters('mcpAppTenantId')]",
        "secret": false
      }
    },
    {
      "type": "Microsoft.ApiManagement/service/namedValues",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}', parameters('apimServiceName'), 'McpClientId')]",
      "properties": {
        "displayName": "McpClientId",
        "value": "[parameters('mcpAppId')]",
        "secret": false
      }
    },
    {
      "type": "Microsoft.ApiManagement/service/namedValues",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}', parameters('apimServiceName'), 'APIMGatewayURL')]",
      "properties": {
        "displayName": "APIMGatewayURL",
        "value": "[reference(resourceId('Microsoft.ApiManagement/service', parameters('apimServiceName')), '2023-09-01-preview').gatewayUrl]",
        "secret": false
      }
    },
    {
      "type": "Microsoft.ApiManagement/service/namedValues",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}', parameters('apimServiceName'), 'npi-function-key')]",
      "properties": {
        "displayName": "npi-function-key",
        "secret": true,
        "value": "[listKeys(format('{0}/host/default', resourceId('Microsoft.Web/sites', format('{0}-npi-lookup-func', parameters('functionAppBaseName')))), '2023-12-01').functionKeys.default]"
      }
    },
    {
      "type": "Microsoft.ApiManagement/service/namedValues",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}', parameters('apimServiceName'), 'icd10-function-key')]",
      "properties": {
        "displayName": "icd10-function-key",
        "secret": true,
        "value": "[listKeys(format('{0}/host/default', resourceId('Microsoft.Web/sites', format('{0}-icd10-validation-func', parameters('functionAppBaseName')))), '2023-12-01').functionKeys.default]"
      }
    },
    {
      "type": "Microsoft.ApiManagement/service/namedValues",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}', parameters('apimServiceName'), 'cms-function-key')]",
      "properties": {
        "displayName": "cms-function-key",
        "secret": true,
        "value": "[listKeys(format('{0}/host/default', resourceId('Microsoft.Web/sites', format('{0}-cms-coverage-func', parameters('functionAppBaseName')))), '2023-12-01').functionKeys.default]"
      }
    },
    {
      "type": "Microsoft.ApiManagement/service/namedValues",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}', parameters('apimServiceName'), 'fhir-function-key')]",
      "properties": {
        "displayName": "fhir-function-key",
        "secret": true,
        "value": "[listKeys(format('{0}/host/default', resourceId('Microsoft.Web/sites', format('{0}-fhir-operations-func', parameters('functionAppBaseName')))), '2023-12-01').functionKeys.default]"
      }
    },
    {
      "type": "Microsoft.ApiManagement/service/namedValues",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}', parameters('apimServiceName'), 'pubmed-function-key')]",
      "properties": {
        "displayName": "pubmed-function-key",
        "secret": true,
        "value": "[listKeys(format('{0}/host/default', resourceId('Microsoft.Web/sites', format('{0}-pubmed-func', parameters('functionAppBaseName')))), '2023-12-01').functionKeys.default]"
      }
    },
    {
      "type": "Microsoft.ApiManagement/service/namedValues",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}', parameters('apimServiceName'), 'clinical-trials-function-key')]",
      "properties": {
        "displayName": "clinical-trials-function-key",
        "secret": true,
        "value": "[listKeys(format('{0}/host/default', resourceId('Microsoft.Web/sites', format('{0}-clinical-trials-func', parameters('functionAppBaseName')))), '2023-12-01').functionKeys.default]"
      }
    },
    {
      "type": "Microsoft.ApiManagement/service/backends",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}', parameters('apimServiceName'), 'npi-backend')]",
      "properties": {
        "title": "NPI Lookup Backend",
        "description": "Backend for NPI Lookup MCP Server",
        "url": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', format('{0}-npi-lookup-func', parameters('functionAppBaseName'))), '2023-12-01').defaultHostName)]",
        "protocol": "http",
        "tls": {
          "validateCertificateChain": true,
          "validateCertificateName": true
        }
      }
    },
    {
      "type": "Microsoft.ApiManagement/service/backends",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}', parameters('apimServiceName'), 'icd10-backend')]",
      "properties": {
        "title": "ICD-10 Validation Backend",
        "description": "Backend for ICD-10 Validation MCP Server",
        "url": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', format('{0}-icd10-validation-func', parameters('functionAppBaseName'))), '2023-12-01').defaultHostName)]",
        "protocol": "http",
        "tls": {
          "validateCertificateChain": true,
          "validateCertificateName": true
        }
      }
    },
    {
      "type": "Microsoft.ApiManagement/service/backends",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}', parameters('apimServiceName'), 'cms-backend')]",
      "properties": {
        "title": "CMS Coverage Backend",
        "description": "Backend for CMS Coverage MCP Server",
        "url": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', format('{0}-cms-coverage-func', parameters('functionAppBaseName'))), '2023-12-01').defaultHostName)]",
        "protocol": "http",
        "tls": {
          "validateCertificateChain": true,
          "validateCertificateName": true
        }
      }
    },
    {
      "type": "Microsoft.ApiManagement/service/backends",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}', parameters('apimServiceName'), 'fhir-backend')]",
      "properties": {
        "title": "FHIR Operations Backend",
        "description": "Backend for FHIR Operations MCP Server",
        "url": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', format('{0}-fhir-operations-func', parameters('functionAppBaseName'))), '2023-12-01').defaultHostName)]",
        "protocol": "http",
        "tls": {
          "validateCertificateChain": true,
          "validateCertificateName": true
        }
      }
    },
    {
      "type": "Microsoft.ApiManagement/service/backends",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}', parameters('apimServiceName'), 'pubmed-backend')]",
      "properties": {
        "title": "PubMed Backend",
        "description": "Backend for PubMed MCP Server",
        "url": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', format('{0}-pubmed-func', parameters('functionAppBaseName'))), '2023-12-01').defaultHostName)]",
        "protocol": "http",
        "tls": {
          "validateCertificateChain": true,
          "validateCertificateName": true
        }
      }
    },
    {
      "type": "Microsoft.ApiManagement/service/backends",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}', parameters('apimServiceName'), 'clinical-trials-backend')]",
      "properties": {
        "title": "Clinical Trials Backend",
        "description": "Backend for Clinical Trials MCP Server",
        "url": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', format('{0}-clinical-trials-func', parameters('functionAppBaseName'))), '2023-12-01').defaultHostName)]",
        "protocol": "http",
        "tls": {
          "validateCertificateChain": true,
          "validateCertificateName": true
        }
      }
    },
    {
      "type": "Microsoft.ApiManagement/service/apis",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}', parameters('apimServiceName'), 'mcp-healthcare')]",
      "properties": {
        "displayName": "Healthcare MCP Servers",
        "description": "Unified API for all Healthcare MCP servers with OAuth protection",
        "path": "mcp",
        "protocols": [
          "https"
        ],
        "subscriptionRequired": false
      }
    },
    {
      "type": "Microsoft.ApiManagement/service/apis/operations",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}/{2}', parameters('apimServiceName'), 'mcp-healthcare', 'prm-discovery')]",
      "properties": {
        "displayName": "Protected Resource Metadata",
        "method": "GET",
        "urlTemplate": "/.well-known/oauth-protected-resource",
        "description": "OAuth discovery endpoint (RFC 9728)"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimServiceName'), 'mcp-healthcare')]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/apis/operations/policies",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}/{2}/{3}', parameters('apimServiceName'), 'mcp-healthcare', 'prm-discovery', 'policy')]",
      "properties": {
        "format": "rawxml",
        "value": "[variables('$fxv#0')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'APIMGatewayURL')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'McpClientId')]",
        "[resourceId('Microsoft.ApiManagement/service/apis/operations', parameters('apimServiceName'), 'mcp-healthcare', 'prm-discovery')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'McpTenantId')]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/apis/operations",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}/{2}', parameters('apimServiceName'), 'mcp-healthcare', 'npi-get')]",
      "properties": {
        "displayName": "NPI Lookup - GET",
        "method": "GET",
        "urlTemplate": "/npi/*",
        "description": "MCP GET endpoint for NPI Lookup server"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimServiceName'), 'mcp-healthcare')]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/apis/operations",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}/{2}', parameters('apimServiceName'), 'mcp-healthcare', 'npi-post')]",
      "properties": {
        "displayName": "NPI Lookup - POST",
        "method": "POST",
        "urlTemplate": "/npi/*",
        "description": "MCP POST endpoint for NPI Lookup server"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimServiceName'), 'mcp-healthcare')]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/apis/operations/policies",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}/{2}/{3}', parameters('apimServiceName'), 'mcp-healthcare', 'npi-get', 'policy')]",
      "properties": {
        "format": "rawxml",
        "value": "<policies>\n  <inbound>\n    <base />\n    <validate-azure-ad-token tenant-id=\"{{McpTenantId}}\" failed-validation-httpcode=\"401\" failed-validation-error-message=\"Unauthorized\">\n      <audiences><audience>{{McpClientId}}</audience></audiences>\n    </validate-azure-ad-token>\n    <set-backend-service backend-id=\"npi-backend\" />\n    <set-header name=\"x-functions-key\" exists-action=\"override\">\n      <value>{{npi-function-key}}</value>\n    </set-header>\n    <rewrite-uri template=\"@{\n      var path = context.Request.Url.Path;\n      var prefix = \"/mcp/npi\";\n      return path.StartsWith(prefix) ? path.Substring(prefix.Length) : path;\n    }\" />\n  </inbound>\n  <backend><base /></backend>\n  <outbound><base /></outbound>\n  <on-error>\n    <base />\n    <choose>\n      <when condition=\"@(context.Response.StatusCode == 401)\">\n        <return-response>\n          <set-status code=\"401\" reason=\"Unauthorized\" />\n          <set-header name=\"WWW-Authenticate\" exists-action=\"override\">\n            <value>Bearer error=\"invalid_token\", resource_metadata=\"{{APIMGatewayURL}}/mcp/.well-known/oauth-protected-resource\"</value>\n          </set-header>\n          <set-body>{\"jsonrpc\": \"2.0\", \"error\": {\"code\": -32001, \"message\": \"Authentication required. Please authenticate using OAuth 2.0.\"}, \"id\": null}</set-body>\n        </return-response>\n      </when>\n    </choose>\n  </on-error>\n</policies>\n"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'APIMGatewayURL')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'McpClientId')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'McpTenantId')]",
        "[resourceId('Microsoft.ApiManagement/service/backends', parameters('apimServiceName'), 'npi-backend')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'npi-function-key')]",
        "[resourceId('Microsoft.ApiManagement/service/apis/operations', parameters('apimServiceName'), 'mcp-healthcare', 'npi-get')]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/apis/operations/policies",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}/{2}/{3}', parameters('apimServiceName'), 'mcp-healthcare', 'npi-post', 'policy')]",
      "properties": {
        "format": "rawxml",
        "value": "<policies>\n  <inbound>\n    <base />\n    <validate-azure-ad-token tenant-id=\"{{McpTenantId}}\" failed-validation-httpcode=\"401\" failed-validation-error-message=\"Unauthorized\">\n      <audiences><audience>{{McpClientId}}</audience></audiences>\n    </validate-azure-ad-token>\n    <set-backend-service backend-id=\"npi-backend\" />\n    <set-header name=\"x-functions-key\" exists-action=\"override\">\n      <value>{{npi-function-key}}</value>\n    </set-header>\n    <rewrite-uri template=\"@{\n      var path = context.Request.Url.Path;\n      var prefix = \"/mcp/npi\";\n      return path.StartsWith(prefix) ? path.Substring(prefix.Length) : path;\n    }\" />\n  </inbound>\n  <backend><base /></backend>\n  <outbound><base /></outbound>\n  <on-error>\n    <base />\n    <choose>\n      <when condition=\"@(context.Response.StatusCode == 401)\">\n        <return-response>\n          <set-status code=\"401\" reason=\"Unauthorized\" />\n          <set-header name=\"WWW-Authenticate\" exists-action=\"override\">\n            <value>Bearer error=\"invalid_token\", resource_metadata=\"{{APIMGatewayURL}}/mcp/.well-known/oauth-protected-resource\"</value>\n          </set-header>\n          <set-body>{\"jsonrpc\": \"2.0\", \"error\": {\"code\": -32001, \"message\": \"Authentication required. Please authenticate using OAuth 2.0.\"}, \"id\": null}</set-body>\n        </return-response>\n      </when>\n    </choose>\n  </on-error>\n</policies>\n"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'APIMGatewayURL')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'McpClientId')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'McpTenantId')]",
        "[resourceId('Microsoft.ApiManagement/service/backends', parameters('apimServiceName'), 'npi-backend')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'npi-function-key')]",
        "[resourceId('Microsoft.ApiManagement/service/apis/operations', parameters('apimServiceName'), 'mcp-healthcare', 'npi-post')]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/apis/operations",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}/{2}', parameters('apimServiceName'), 'mcp-healthcare', 'icd10-get')]",
      "properties": {
        "displayName": "ICD-10 Validation - GET",
        "method": "GET",
        "urlTemplate": "/icd10/*",
        "description": "MCP GET endpoint for ICD-10 Validation server"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimServiceName'), 'mcp-healthcare')]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/apis/operations",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}/{2}', parameters('apimServiceName'), 'mcp-healthcare', 'icd10-post')]",
      "properties": {
        "displayName": "ICD-10 Validation - POST",
        "method": "POST",
        "urlTemplate": "/icd10/*",
        "description": "MCP POST endpoint for ICD-10 Validation server"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimServiceName'), 'mcp-healthcare')]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/apis/operations/policies",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}/{2}/{3}', parameters('apimServiceName'), 'mcp-healthcare', 'icd10-get', 'policy')]",
      "properties": {
        "format": "rawxml",
        "value": "<policies>\n  <inbound>\n    <base />\n    <validate-azure-ad-token tenant-id=\"{{McpTenantId}}\" failed-validation-httpcode=\"401\" failed-validation-error-message=\"Unauthorized\">\n      <audiences><audience>{{McpClientId}}</audience></audiences>\n    </validate-azure-ad-token>\n    <set-backend-service backend-id=\"icd10-backend\" />\n    <set-header name=\"x-functions-key\" exists-action=\"override\">\n      <value>{{icd10-function-key}}</value>\n    </set-header>\n    <rewrite-uri template=\"@{\n      var path = context.Request.Url.Path;\n      var prefix = \"/mcp/icd10\";\n      return path.StartsWith(prefix) ? path.Substring(prefix.Length) : path;\n    }\" />\n  </inbound>\n  <backend><base /></backend>\n  <outbound><base /></outbound>\n  <on-error>\n    <base />\n    <choose>\n      <when condition=\"@(context.Response.StatusCode == 401)\">\n        <return-response>\n          <set-status code=\"401\" reason=\"Unauthorized\" />\n          <set-header name=\"WWW-Authenticate\" exists-action=\"override\">\n            <value>Bearer error=\"invalid_token\", resource_metadata=\"{{APIMGatewayURL}}/mcp/.well-known/oauth-protected-resource\"</value>\n          </set-header>\n          <set-body>{\"jsonrpc\": \"2.0\", \"error\": {\"code\": -32001, \"message\": \"Authentication required. Please authenticate using OAuth 2.0.\"}, \"id\": null}</set-body>\n        </return-response>\n      </when>\n    </choose>\n  </on-error>\n</policies>\n"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'APIMGatewayURL')]",
        "[resourceId('Microsoft.ApiManagement/service/backends', parameters('apimServiceName'), 'icd10-backend')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'icd10-function-key')]",
        "[resourceId('Microsoft.ApiManagement/service/apis/operations', parameters('apimServiceName'), 'mcp-healthcare', 'icd10-get')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'McpClientId')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'McpTenantId')]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/apis/operations/policies",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}/{2}/{3}', parameters('apimServiceName'), 'mcp-healthcare', 'icd10-post', 'policy')]",
      "properties": {
        "format": "rawxml",
        "value": "<policies>\n  <inbound>\n    <base />\n    <validate-azure-ad-token tenant-id=\"{{McpTenantId}}\" failed-validation-httpcode=\"401\" failed-validation-error-message=\"Unauthorized\">\n      <audiences><audience>{{McpClientId}}</audience></audiences>\n    </validate-azure-ad-token>\n    <set-backend-service backend-id=\"icd10-backend\" />\n    <set-header name=\"x-functions-key\" exists-action=\"override\">\n      <value>{{icd10-function-key}}</value>\n    </set-header>\n    <rewrite-uri template=\"@{\n      var path = context.Request.Url.Path;\n      var prefix = \"/mcp/icd10\";\n      return path.StartsWith(prefix) ? path.Substring(prefix.Length) : path;\n    }\" />\n  </inbound>\n  <backend><base /></backend>\n  <outbound><base /></outbound>\n  <on-error>\n    <base />\n    <choose>\n      <when condition=\"@(context.Response.StatusCode == 401)\">\n        <return-response>\n          <set-status code=\"401\" reason=\"Unauthorized\" />\n          <set-header name=\"WWW-Authenticate\" exists-action=\"override\">\n            <value>Bearer error=\"invalid_token\", resource_metadata=\"{{APIMGatewayURL}}/mcp/.well-known/oauth-protected-resource\"</value>\n          </set-header>\n          <set-body>{\"jsonrpc\": \"2.0\", \"error\": {\"code\": -32001, \"message\": \"Authentication required. Please authenticate using OAuth 2.0.\"}, \"id\": null}</set-body>\n        </return-response>\n      </when>\n    </choose>\n  </on-error>\n</policies>\n"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'APIMGatewayURL')]",
        "[resourceId('Microsoft.ApiManagement/service/backends', parameters('apimServiceName'), 'icd10-backend')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'icd10-function-key')]",
        "[resourceId('Microsoft.ApiManagement/service/apis/operations', parameters('apimServiceName'), 'mcp-healthcare', 'icd10-post')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'McpClientId')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'McpTenantId')]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/apis/operations",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}/{2}', parameters('apimServiceName'), 'mcp-healthcare', 'cms-get')]",
      "properties": {
        "displayName": "CMS Coverage - GET",
        "method": "GET",
        "urlTemplate": "/cms/*",
        "description": "MCP GET endpoint for CMS Coverage server"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimServiceName'), 'mcp-healthcare')]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/apis/operations",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}/{2}', parameters('apimServiceName'), 'mcp-healthcare', 'cms-post')]",
      "properties": {
        "displayName": "CMS Coverage - POST",
        "method": "POST",
        "urlTemplate": "/cms/*",
        "description": "MCP POST endpoint for CMS Coverage server"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimServiceName'), 'mcp-healthcare')]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/apis/operations/policies",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}/{2}/{3}', parameters('apimServiceName'), 'mcp-healthcare', 'cms-get', 'policy')]",
      "properties": {
        "format": "rawxml",
        "value": "<policies>\n  <inbound>\n    <base />\n    <validate-azure-ad-token tenant-id=\"{{McpTenantId}}\" failed-validation-httpcode=\"401\" failed-validation-error-message=\"Unauthorized\">\n      <audiences><audience>{{McpClientId}}</audience></audiences>\n    </validate-azure-ad-token>\n    <set-backend-service backend-id=\"cms-backend\" />\n    <set-header name=\"x-functions-key\" exists-action=\"override\">\n      <value>{{cms-function-key}}</value>\n    </set-header>\n    <rewrite-uri template=\"@{\n      var path = context.Request.Url.Path;\n      var prefix = \"/mcp/cms\";\n      return path.StartsWith(prefix) ? path.Substring(prefix.Length) : path;\n    }\" />\n  </inbound>\n  <backend><base /></backend>\n  <outbound><base /></outbound>\n  <on-error>\n    <base />\n    <choose>\n      <when condition=\"@(context.Response.StatusCode == 401)\">\n        <return-response>\n          <set-status code=\"401\" reason=\"Unauthorized\" />\n          <set-header name=\"WWW-Authenticate\" exists-action=\"override\">\n            <value>Bearer error=\"invalid_token\", resource_metadata=\"{{APIMGatewayURL}}/mcp/.well-known/oauth-protected-resource\"</value>\n          </set-header>\n          <set-body>{\"jsonrpc\": \"2.0\", \"error\": {\"code\": -32001, \"message\": \"Authentication required. Please authenticate using OAuth 2.0.\"}, \"id\": null}</set-body>\n        </return-response>\n      </when>\n    </choose>\n  </on-error>\n</policies>\n"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'APIMGatewayURL')]",
        "[resourceId('Microsoft.ApiManagement/service/backends', parameters('apimServiceName'), 'cms-backend')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'cms-function-key')]",
        "[resourceId('Microsoft.ApiManagement/service/apis/operations', parameters('apimServiceName'), 'mcp-healthcare', 'cms-get')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'McpClientId')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'McpTenantId')]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/apis/operations/policies",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}/{2}/{3}', parameters('apimServiceName'), 'mcp-healthcare', 'cms-post', 'policy')]",
      "properties": {
        "format": "rawxml",
        "value": "<policies>\n  <inbound>\n    <base />\n    <validate-azure-ad-token tenant-id=\"{{McpTenantId}}\" failed-validation-httpcode=\"401\" failed-validation-error-message=\"Unauthorized\">\n      <audiences><audience>{{McpClientId}}</audience></audiences>\n    </validate-azure-ad-token>\n    <set-backend-service backend-id=\"cms-backend\" />\n    <set-header name=\"x-functions-key\" exists-action=\"override\">\n      <value>{{cms-function-key}}</value>\n    </set-header>\n    <rewrite-uri template=\"@{\n      var path = context.Request.Url.Path;\n      var prefix = \"/mcp/cms\";\n      return path.StartsWith(prefix) ? path.Substring(prefix.Length) : path;\n    }\" />\n  </inbound>\n  <backend><base /></backend>\n  <outbound><base /></outbound>\n  <on-error>\n    <base />\n    <choose>\n      <when condition=\"@(context.Response.StatusCode == 401)\">\n        <return-response>\n          <set-status code=\"401\" reason=\"Unauthorized\" />\n          <set-header name=\"WWW-Authenticate\" exists-action=\"override\">\n            <value>Bearer error=\"invalid_token\", resource_metadata=\"{{APIMGatewayURL}}/mcp/.well-known/oauth-protected-resource\"</value>\n          </set-header>\n          <set-body>{\"jsonrpc\": \"2.0\", \"error\": {\"code\": -32001, \"message\": \"Authentication required. Please authenticate using OAuth 2.0.\"}, \"id\": null}</set-body>\n        </return-response>\n      </when>\n    </choose>\n  </on-error>\n</policies>\n"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'APIMGatewayURL')]",
        "[resourceId('Microsoft.ApiManagement/service/backends', parameters('apimServiceName'), 'cms-backend')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'cms-function-key')]",
        "[resourceId('Microsoft.ApiManagement/service/apis/operations', parameters('apimServiceName'), 'mcp-healthcare', 'cms-post')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'McpClientId')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'McpTenantId')]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/apis/operations",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}/{2}', parameters('apimServiceName'), 'mcp-healthcare', 'fhir-get')]",
      "properties": {
        "displayName": "FHIR Operations - GET",
        "method": "GET",
        "urlTemplate": "/fhir/*",
        "description": "MCP GET endpoint for FHIR Operations server"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimServiceName'), 'mcp-healthcare')]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/apis/operations",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}/{2}', parameters('apimServiceName'), 'mcp-healthcare', 'fhir-post')]",
      "properties": {
        "displayName": "FHIR Operations - POST",
        "method": "POST",
        "urlTemplate": "/fhir/*",
        "description": "MCP POST endpoint for FHIR Operations server"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimServiceName'), 'mcp-healthcare')]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/apis/operations/policies",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}/{2}/{3}', parameters('apimServiceName'), 'mcp-healthcare', 'fhir-get', 'policy')]",
      "properties": {
        "format": "rawxml",
        "value": "<policies>\n  <inbound>\n    <base />\n    <validate-azure-ad-token tenant-id=\"{{McpTenantId}}\" failed-validation-httpcode=\"401\" failed-validation-error-message=\"Unauthorized\">\n      <audiences><audience>{{McpClientId}}</audience></audiences>\n    </validate-azure-ad-token>\n    <set-backend-service backend-id=\"fhir-backend\" />\n    <set-header name=\"x-functions-key\" exists-action=\"override\">\n      <value>{{fhir-function-key}}</value>\n    </set-header>\n    <rewrite-uri template=\"@{\n      var path = context.Request.Url.Path;\n      var prefix = \"/mcp/fhir\";\n      return path.StartsWith(prefix) ? path.Substring(prefix.Length) : path;\n    }\" />\n  </inbound>\n  <backend><base /></backend>\n  <outbound><base /></outbound>\n  <on-error>\n    <base />\n    <choose>\n      <when condition=\"@(context.Response.StatusCode == 401)\">\n        <return-response>\n          <set-status code=\"401\" reason=\"Unauthorized\" />\n          <set-header name=\"WWW-Authenticate\" exists-action=\"override\">\n            <value>Bearer error=\"invalid_token\", resource_metadata=\"{{APIMGatewayURL}}/mcp/.well-known/oauth-protected-resource\"</value>\n          </set-header>\n          <set-body>{\"jsonrpc\": \"2.0\", \"error\": {\"code\": -32001, \"message\": \"Authentication required. Please authenticate using OAuth 2.0.\"}, \"id\": null}</set-body>\n        </return-response>\n      </when>\n    </choose>\n  </on-error>\n</policies>\n"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'APIMGatewayURL')]",
        "[resourceId('Microsoft.ApiManagement/service/backends', parameters('apimServiceName'), 'fhir-backend')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'fhir-function-key')]",
        "[resourceId('Microsoft.ApiManagement/service/apis/operations', parameters('apimServiceName'), 'mcp-healthcare', 'fhir-get')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'McpClientId')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'McpTenantId')]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/apis/operations/policies",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}/{2}/{3}', parameters('apimServiceName'), 'mcp-healthcare', 'fhir-post', 'policy')]",
      "properties": {
        "format": "rawxml",
        "value": "<policies>\n  <inbound>\n    <base />\n    <validate-azure-ad-token tenant-id=\"{{McpTenantId}}\" failed-validation-httpcode=\"401\" failed-validation-error-message=\"Unauthorized\">\n      <audiences><audience>{{McpClientId}}</audience></audiences>\n    </validate-azure-ad-token>\n    <set-backend-service backend-id=\"fhir-backend\" />\n    <set-header name=\"x-functions-key\" exists-action=\"override\">\n      <value>{{fhir-function-key}}</value>\n    </set-header>\n    <rewrite-uri template=\"@{\n      var path = context.Request.Url.Path;\n      var prefix = \"/mcp/fhir\";\n      return path.StartsWith(prefix) ? path.Substring(prefix.Length) : path;\n    }\" />\n  </inbound>\n  <backend><base /></backend>\n  <outbound><base /></outbound>\n  <on-error>\n    <base />\n    <choose>\n      <when condition=\"@(context.Response.StatusCode == 401)\">\n        <return-response>\n          <set-status code=\"401\" reason=\"Unauthorized\" />\n          <set-header name=\"WWW-Authenticate\" exists-action=\"override\">\n            <value>Bearer error=\"invalid_token\", resource_metadata=\"{{APIMGatewayURL}}/mcp/.well-known/oauth-protected-resource\"</value>\n          </set-header>\n          <set-body>{\"jsonrpc\": \"2.0\", \"error\": {\"code\": -32001, \"message\": \"Authentication required. Please authenticate using OAuth 2.0.\"}, \"id\": null}</set-body>\n        </return-response>\n      </when>\n    </choose>\n  </on-error>\n</policies>\n"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'APIMGatewayURL')]",
        "[resourceId('Microsoft.ApiManagement/service/backends', parameters('apimServiceName'), 'fhir-backend')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'fhir-function-key')]",
        "[resourceId('Microsoft.ApiManagement/service/apis/operations', parameters('apimServiceName'), 'mcp-healthcare', 'fhir-post')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'McpClientId')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'McpTenantId')]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/apis/operations",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}/{2}', parameters('apimServiceName'), 'mcp-healthcare', 'pubmed-get')]",
      "properties": {
        "displayName": "PubMed - GET",
        "method": "GET",
        "urlTemplate": "/pubmed/*",
        "description": "MCP GET endpoint for PubMed server"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimServiceName'), 'mcp-healthcare')]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/apis/operations",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}/{2}', parameters('apimServiceName'), 'mcp-healthcare', 'pubmed-post')]",
      "properties": {
        "displayName": "PubMed - POST",
        "method": "POST",
        "urlTemplate": "/pubmed/*",
        "description": "MCP POST endpoint for PubMed server"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimServiceName'), 'mcp-healthcare')]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/apis/operations/policies",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}/{2}/{3}', parameters('apimServiceName'), 'mcp-healthcare', 'pubmed-get', 'policy')]",
      "properties": {
        "format": "rawxml",
        "value": "<policies>\n  <inbound>\n    <base />\n    <validate-azure-ad-token tenant-id=\"{{McpTenantId}}\" failed-validation-httpcode=\"401\" failed-validation-error-message=\"Unauthorized\">\n      <audiences><audience>{{McpClientId}}</audience></audiences>\n    </validate-azure-ad-token>\n    <set-backend-service backend-id=\"pubmed-backend\" />\n    <set-header name=\"x-functions-key\" exists-action=\"override\">\n      <value>{{pubmed-function-key}}</value>\n    </set-header>\n    <rewrite-uri template=\"@{\n      var path = context.Request.Url.Path;\n      var prefix = \"/mcp/pubmed\";\n      return path.StartsWith(prefix) ? path.Substring(prefix.Length) : path;\n    }\" />\n  </inbound>\n  <backend><base /></backend>\n  <outbound><base /></outbound>\n  <on-error>\n    <base />\n    <choose>\n      <when condition=\"@(context.Response.StatusCode == 401)\">\n        <return-response>\n          <set-status code=\"401\" reason=\"Unauthorized\" />\n          <set-header name=\"WWW-Authenticate\" exists-action=\"override\">\n            <value>Bearer error=\"invalid_token\", resource_metadata=\"{{APIMGatewayURL}}/mcp/.well-known/oauth-protected-resource\"</value>\n          </set-header>\n          <set-body>{\"jsonrpc\": \"2.0\", \"error\": {\"code\": -32001, \"message\": \"Authentication required. Please authenticate using OAuth 2.0.\"}, \"id\": null}</set-body>\n        </return-response>\n      </when>\n    </choose>\n  </on-error>\n</policies>\n"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'APIMGatewayURL')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'McpClientId')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'McpTenantId')]",
        "[resourceId('Microsoft.ApiManagement/service/backends', parameters('apimServiceName'), 'pubmed-backend')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'pubmed-function-key')]",
        "[resourceId('Microsoft.ApiManagement/service/apis/operations', parameters('apimServiceName'), 'mcp-healthcare', 'pubmed-get')]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/apis/operations/policies",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}/{2}/{3}', parameters('apimServiceName'), 'mcp-healthcare', 'pubmed-post', 'policy')]",
      "properties": {
        "format": "rawxml",
        "value": "<policies>\n  <inbound>\n    <base />\n    <validate-azure-ad-token tenant-id=\"{{McpTenantId}}\" failed-validation-httpcode=\"401\" failed-validation-error-message=\"Unauthorized\">\n      <audiences><audience>{{McpClientId}}</audience></audiences>\n    </validate-azure-ad-token>\n    <set-backend-service backend-id=\"pubmed-backend\" />\n    <set-header name=\"x-functions-key\" exists-action=\"override\">\n      <value>{{pubmed-function-key}}</value>\n    </set-header>\n    <rewrite-uri template=\"@{\n      var path = context.Request.Url.Path;\n      var prefix = \"/mcp/pubmed\";\n      return path.StartsWith(prefix) ? path.Substring(prefix.Length) : path;\n    }\" />\n  </inbound>\n  <backend><base /></backend>\n  <outbound><base /></outbound>\n  <on-error>\n    <base />\n    <choose>\n      <when condition=\"@(context.Response.StatusCode == 401)\">\n        <return-response>\n          <set-status code=\"401\" reason=\"Unauthorized\" />\n          <set-header name=\"WWW-Authenticate\" exists-action=\"override\">\n            <value>Bearer error=\"invalid_token\", resource_metadata=\"{{APIMGatewayURL}}/mcp/.well-known/oauth-protected-resource\"</value>\n          </set-header>\n          <set-body>{\"jsonrpc\": \"2.0\", \"error\": {\"code\": -32001, \"message\": \"Authentication required. Please authenticate using OAuth 2.0.\"}, \"id\": null}</set-body>\n        </return-response>\n      </when>\n    </choose>\n  </on-error>\n</policies>\n"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'APIMGatewayURL')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'McpClientId')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'McpTenantId')]",
        "[resourceId('Microsoft.ApiManagement/service/backends', parameters('apimServiceName'), 'pubmed-backend')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'pubmed-function-key')]",
        "[resourceId('Microsoft.ApiManagement/service/apis/operations', parameters('apimServiceName'), 'mcp-healthcare', 'pubmed-post')]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/apis/operations",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}/{2}', parameters('apimServiceName'), 'mcp-healthcare', 'clinical-trials-get')]",
      "properties": {
        "displayName": "Clinical Trials - GET",
        "method": "GET",
        "urlTemplate": "/clinical-trials/*",
        "description": "MCP GET endpoint for Clinical Trials server"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimServiceName'), 'mcp-healthcare')]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/apis/operations",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}/{2}', parameters('apimServiceName'), 'mcp-healthcare', 'clinical-trials-post')]",
      "properties": {
        "displayName": "Clinical Trials - POST",
        "method": "POST",
        "urlTemplate": "/clinical-trials/*",
        "description": "MCP POST endpoint for Clinical Trials server"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimServiceName'), 'mcp-healthcare')]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/apis/operations/policies",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}/{2}/{3}', parameters('apimServiceName'), 'mcp-healthcare', 'clinical-trials-get', 'policy')]",
      "properties": {
        "format": "rawxml",
        "value": "<policies>\n  <inbound>\n    <base />\n    <validate-azure-ad-token tenant-id=\"{{McpTenantId}}\" failed-validation-httpcode=\"401\" failed-validation-error-message=\"Unauthorized\">\n      <audiences><audience>{{McpClientId}}</audience></audiences>\n    </validate-azure-ad-token>\n    <set-backend-service backend-id=\"clinical-trials-backend\" />\n    <set-header name=\"x-functions-key\" exists-action=\"override\">\n      <value>{{clinical-trials-function-key}}</value>\n    </set-header>\n    <rewrite-uri template=\"@{\n      var path = context.Request.Url.Path;\n      var prefix = \"/mcp/clinical-trials\";\n      return path.StartsWith(prefix) ? path.Substring(prefix.Length) : path;\n    }\" />\n  </inbound>\n  <backend><base /></backend>\n  <outbound><base /></outbound>\n  <on-error>\n    <base />\n    <choose>\n      <when condition=\"@(context.Response.StatusCode == 401)\">\n        <return-response>\n          <set-status code=\"401\" reason=\"Unauthorized\" />\n          <set-header name=\"WWW-Authenticate\" exists-action=\"override\">\n            <value>Bearer error=\"invalid_token\", resource_metadata=\"{{APIMGatewayURL}}/mcp/.well-known/oauth-protected-resource\"</value>\n          </set-header>\n          <set-body>{\"jsonrpc\": \"2.0\", \"error\": {\"code\": -32001, \"message\": \"Authentication required. Please authenticate using OAuth 2.0.\"}, \"id\": null}</set-body>\n        </return-response>\n      </when>\n    </choose>\n  </on-error>\n</policies>\n"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'APIMGatewayURL')]",
        "[resourceId('Microsoft.ApiManagement/service/backends', parameters('apimServiceName'), 'clinical-trials-backend')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'clinical-trials-function-key')]",
        "[resourceId('Microsoft.ApiManagement/service/apis/operations', parameters('apimServiceName'), 'mcp-healthcare', 'clinical-trials-get')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'McpClientId')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'McpTenantId')]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/apis/operations/policies",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}/{2}/{3}', parameters('apimServiceName'), 'mcp-healthcare', 'clinical-trials-post', 'policy')]",
      "properties": {
        "format": "rawxml",
        "value": "<policies>\n  <inbound>\n    <base />\n    <validate-azure-ad-token tenant-id=\"{{McpTenantId}}\" failed-validation-httpcode=\"401\" failed-validation-error-message=\"Unauthorized\">\n      <audiences><audience>{{McpClientId}}</audience></audiences>\n    </validate-azure-ad-token>\n    <set-backend-service backend-id=\"clinical-trials-backend\" />\n    <set-header name=\"x-functions-key\" exists-action=\"override\">\n      <value>{{clinical-trials-function-key}}</value>\n    </set-header>\n    <rewrite-uri template=\"@{\n      var path = context.Request.Url.Path;\n      var prefix = \"/mcp/clinical-trials\";\n      return path.StartsWith(prefix) ? path.Substring(prefix.Length) : path;\n    }\" />\n  </inbound>\n  <backend><base /></backend>\n  <outbound><base /></outbound>\n  <on-error>\n    <base />\n    <choose>\n      <when condition=\"@(context.Response.StatusCode == 401)\">\n        <return-response>\n          <set-status code=\"401\" reason=\"Unauthorized\" />\n          <set-header name=\"WWW-Authenticate\" exists-action=\"override\">\n            <value>Bearer error=\"invalid_token\", resource_metadata=\"{{APIMGatewayURL}}/mcp/.well-known/oauth-protected-resource\"</value>\n          </set-header>\n          <set-body>{\"jsonrpc\": \"2.0\", \"error\": {\"code\": -32001, \"message\": \"Authentication required. Please authenticate using OAuth 2.0.\"}, \"id\": null}</set-body>\n        </return-response>\n      </when>\n    </choose>\n  </on-error>\n</policies>\n"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'APIMGatewayURL')]",
        "[resourceId('Microsoft.ApiManagement/service/backends', parameters('apimServiceName'), 'clinical-trials-backend')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'clinical-trials-function-key')]",
        "[resourceId('Microsoft.ApiManagement/service/apis/operations', parameters('apimServiceName'), 'mcp-healthcare', 'clinical-trials-post')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'McpClientId')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'McpTenantId')]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/apis",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}', parameters('apimServiceName'), 'mcp-prm')]",
      "properties": {
        "displayName": "MCP Protected Resource Metadata",
        "description": "OAuth discovery endpoint for MCP clients (RFC 9728)",
        "path": "",
        "protocols": [
          "https"
        ],
        "subscriptionRequired": false
      }
    },
    {
      "type": "Microsoft.ApiManagement/service/apis/operations",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}/{2}', parameters('apimServiceName'), 'mcp-prm', 'prm-discovery')]",
      "properties": {
        "displayName": "Protected Resource Metadata",
        "method": "GET",
        "urlTemplate": "/.well-known/oauth-protected-resource",
        "description": "Returns OAuth configuration for MCP clients"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimServiceName'), 'mcp-prm')]"
      ]
    },
    {
      "type": "Microsoft.ApiManagement/service/apis/operations/policies",
      "apiVersion": "2023-09-01-preview",
      "name": "[format('{0}/{1}/{2}/{3}', parameters('apimServiceName'), 'mcp-prm', 'prm-discovery', 'policy')]",
      "properties": {
        "format": "rawxml",
        "value": "[variables('$fxv#1')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'APIMGatewayURL')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'McpClientId')]",
        "[resourceId('Microsoft.ApiManagement/service/namedValues', parameters('apimServiceName'), 'McpTenantId')]",
        "[resourceId('Microsoft.ApiManagement/service/apis/operations', parameters('apimServiceName'), 'mcp-prm', 'prm-discovery')]"
      ]
    }
  ],
  "outputs": {
    "prmEndpoint": {
      "type": "string",
      "value": "[format('{0}/.well-known/oauth-protected-resource', reference(resourceId('Microsoft.ApiManagement/service', parameters('apimServiceName')), '2023-09-01-preview').gatewayUrl)]"
    },
    "mcpApiId": {
      "type": "string",
      "value": "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apimServiceName'), 'mcp-healthcare')]"
    },
    "mcpApiPath": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.ApiManagement/service/apis', parameters('apimServiceName'), 'mcp-healthcare'), '2023-09-01-preview').path]"
    }
  }
}