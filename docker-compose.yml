# ============================================================================
# Healthcare MCP Servers — Docker Compose (Consolidated)
# ============================================================================
# Spins up the 3 consolidated MCP servers as containers using the shared Dockerfile.
#
# Quick start:
#   docker compose up --build          # foreground
#   docker compose up --build -d       # detached
#   docker compose down                # stop & remove
#
# Consolidated server mapping:
#   mcp-reference-data    → 7071  (NPI + ICD-10 + CMS)
#   mcp-clinical-research → 7072  (FHIR + PubMed + ClinicalTrials)
#   cosmos-rag            → 7073  (Cosmos DB RAG & Audit)
# ============================================================================

x-mcp-server: &mcp-server-defaults
  build:
    context: ./src/mcp-servers
    dockerfile: Dockerfile
  platform: linux/amd64
  restart: unless-stopped
  healthcheck:
    test: ["CMD", "curl", "-sf", "http://localhost/health?code=docker-default-key"]
    interval: 30s
    timeout: 5s
    retries: 3
    start_period: 40s
  networks:
    - mcp-network

services:
  # --------------------------------------------------------------------------
  # Reference Data: NPI Lookup + ICD-10 Validation + CMS Coverage (12 tools)
  # --------------------------------------------------------------------------
  mcp-reference-data:
    <<: *mcp-server-defaults
    container_name: mcp-reference-data
    build:
      context: ./src/mcp-servers
      dockerfile: Dockerfile
      args:
        SERVER_NAME: mcp-reference-data
    ports:
      - "7071:80"
    environment:
      - MCP_SERVER_NAME=mcp-reference-data

  # --------------------------------------------------------------------------
  # Clinical Research: FHIR + PubMed + Clinical Trials (20 tools)
  # --------------------------------------------------------------------------
  mcp-clinical-research:
    <<: *mcp-server-defaults
    container_name: mcp-clinical-research
    build:
      context: ./src/mcp-servers
      dockerfile: Dockerfile
      args:
        SERVER_NAME: mcp-clinical-research
    ports:
      - "7072:80"
    environment:
      - MCP_SERVER_NAME=mcp-clinical-research
      - FHIR_SERVER_URL=${FHIR_SERVER_URL:-}
      - NCBI_API_KEY=${NCBI_API_KEY:-}

  # --------------------------------------------------------------------------
  # Cosmos DB RAG & Audit (6 tools)
  # --------------------------------------------------------------------------
  cosmos-rag:
    <<: *mcp-server-defaults
    container_name: mcp-cosmos-rag
    build:
      context: ./src/mcp-servers
      dockerfile: Dockerfile
      args:
        SERVER_NAME: cosmos-rag
    ports:
      - "7073:80"
    environment:
      - MCP_SERVER_NAME=cosmos-rag
      - COSMOS_DB_ENDPOINT=${COSMOS_DB_ENDPOINT:-}
      - COSMOS_DB_DATABASE=${COSMOS_DB_DATABASE:-healthcare-mcp}
      - AZURE_AI_SERVICES_ENDPOINT=${AZURE_AI_SERVICES_ENDPOINT:-}
      - EMBEDDING_DEPLOYMENT_NAME=${EMBEDDING_DEPLOYMENT_NAME:-text-embedding-3-large}
      - EMBEDDING_DIMENSIONS=${EMBEDDING_DIMENSIONS:-3072}

networks:
  mcp-network:
    driver: bridge
